
<div  id="user-bar">
    <div class="user">

        <figure @click="viewNotifications" class="avatar">
            <img v-bind:src="user.picture">
            <figcaption v-show="notificationsCount > 0" class="notifications-icon">
                <span  class="notifications-count" v-text="notificationsCount"></span>

            </figcaption>
        </figure>
        <div class="user-data">

            <span class="name" v-text="user.name"></span>
            <span class="surname" v-text="user.surname"></span>

        </div>


    </div>


    <vue-modaltor
            :visible="showNotifications"
            @hide="hideModal"
            :resize-width='{1200:"60%",992:"80%",768:"90%"}'
    >
        <ul class="notifications" v-if="notifications">
            <li class="notification" v-for="notification in notifications" v-if="notification.data.status != 3">

                <template v-if="notification.data.type == 'friendship-update' ">


                    <a v-bind:href="getNotificationLink(notification.data)"  class="friendship-update">

                        <figure class="user-avatar">
                            <img v-bind:src="notification.data.user.picture">

                        </figure>
                        <div class="notification-data">
                            <span class="name" v-text="notification.data.user.name"></span>
                            <span class="surname" v-text="notification.data.user.surname"></span>

                            <p class="text">

                                <template v-if="notification.data.status==1">desea ser tu amigo/a</template>
                                <template v-if="notification.data.status==2">ahora es tu amigo/a</template>
                            </p>
                        </div>
                    </a>


                </template>

            </li>
        </ul>




    </vue-modaltor>

</div>


<script>


    (function () {

        //TODO: fire on visibility change (when is seen)
        var usr = Cookies.getJSON("usr");
          userBar =  new Vue({
            el: '#user-bar',
            data: {
                notificationsCount: 0,
                user:usr,
                showNotifications:false,
                notifications:[]
            },
            methods:{
                viewNotifications:function () {


                    if(this.notifications.length)
                    {
                        this.showNotifications = true;
                    }

                },
                hideModal:function(){
                    markAsSeenNotifications();
                    this.showNotifications = false
                },
                getNotificationLink:function (data) {

                    if(data.type == 'friendship-update')
                    {
                        switch (data.status)
                        {
                            case 1:

                                return '/me/friends/pending';

                                break;
                            default:

                                return '';

                                break;
                        }
                    }

                }
            }
        });

        function markAsSeenNotifications() {

            Cookies.remove('notifications',{path:'/'});
            //TODO: handle ajax errors
            axios({
                method:'post',
                url:'/me/readnotifications'
            })
                .then(function(response) {

                    Vue.set(userBar,'notifications',[]);
                    Vue.set(userBar,'notificationsCount',0);


                });




        }

        function getNotifications(markAsSeen,callback) {

            var notifications = (Cookies.getJSON("notifications"))?Cookies.getJSON("notifications"):[];

            if(notifications.length > 0)
            {
                return callback(notifications);
            }


            //TODO: handle ajax errors
            axios({
                method:'get',
                url:'/me/notifications'
            })
                .then(function(response) {



                    var notifications = response.data.results;

                    Cookies.set('notifications',JSON.stringify(notifications));

                    if(markAsSeen)
                    {
                        markAsSeenNotifications();
                    }


                    callback(notifications);



                });

            /*
            var usr = Cookies.getJSON("usr");

            var notifications = [];

            if(usr.notifications)
            {
                Array.prototype.push.apply(notifications, usr.notifications);

            }

            var cookieNotifications = (Cookies.getJSON("notifications"))?Cookies.getJSON("notifications"):[];


            Array.prototype.push.apply(notifications,cookieNotifications);
            */



        }

      getNotifications(false,function (results) {

          userBar.notificationsCount = results.length;
              userBar.notifications = results;
        });


        wse.bind('notification',function (data) {


            if(data.type='friendship-update' && data.data.status == 3)
            {
                return false;
            }


            userBar.notificationsCount++;

            userBar.notifications.push(data);

            Cookies.set('notifications',JSON.stringify(userBar.notifications));


        })
        })();


</script>